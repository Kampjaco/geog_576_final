<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weather App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
    <div class="container-fluid">
      <div class="weather-wrapper bg-white p-4 mt-5 rounded shadow w-60" style="width: 50%;">
        <h1 class="mb-4">Weather Forecast</h1>
        <form id="weatherForm">
          <div class="mb-3">
            <label for="locationInput" class="form-label">Enter Location</label>
            <input type="text" class="form-control" id="locationInput" placeholder="e.g., Minneapolis">
          </div>
          <button type="submit" class="btn btn-primary">Get Weather</button>
        </form>
        <div id="weatherResult" class="mt-4 border rounded p-3 bg-light">
          <div class="row">
            <div id="curWeatherResult" class="col-md-6">
              <!-- Current weather goes here -->
            </div>
            <div id="forecastWeatherResult" class="col-md-6">
              <div class="row" id="forecastWeatherGrid">
                  <!-- Forecast weather goes here -->
              </div>
            </div>
          </div>
        </div>
        </div>
      </div>
    </div>

    <script>
      //Gets weather data for city provided by user
      //Updates weather data every time a new location is submitted
      async function fetchWeather(location) {
        const weatherResult = document.getElementById('weatherResult');

        const curWeatherResult = document.getElementById('curWeatherResult');
        const forecastWeatherGrid = document.getElementById('forecastWeatherGrid');
    
        try {
          // Fetch current weather
          const currentRes = await fetch(`/current?location=${encodeURIComponent(location)}`);
          const currentData = await currentRes.json();

          // Fetch 4-day forecast
          const forecastRes = await fetch(`/weather?location=${encodeURIComponent(location)}`);
          const forecastData = await forecastRes.json();
    
          if (currentData.error || currentData.cod === "404" || forecastData.error || forecastData.cod === "404") {
            weatherResult.innerHTML = `<p class="text-danger">Could not find weather for "${location}".</p>`;
          } else {
            //Current weather data
            curWeatherResult.innerHTML = `
              <h5>${currentData.name}, ${currentData.sys.country}</h5>
              <p>Temp: ${Math.round(currentData.main.temp)} °F</p>
              <p>Weather: ${currentData.weather[0].main}</p>
            `;

            //Forecast weather data
            forecastWeatherGrid.innerHTML = "";

            //Starts reading from list[1] onwards
            //Element at list[0] is current weather conditions, which are found using above code block
            forecastData.list.slice(1).forEach((day, index) => {
              const formattedDate = formatForecastDate(day.dt, index);

              forecastWeatherGrid.innerHTML += `
                <div class="col-6 mb-3">
                  <h6>${formattedDate}</h6>
                  <p>High: ${Math.round(day.temp.max)} °F</p>
                  <p>Low: ${Math.round(day.temp.min)} °F</p>
                  <p>${day.weather[0].main}</p>
                  <img src="http://openweathermap.org/img/wn/${day.weather[0].icon}.png" alt="Weather icon">
                </div>
              `;
            });

          }
        } catch (err) {
          weatherResult.innerHTML = `<p class="text-danger">Error fetching weather data.</p>`;
          console.error(err);
        }
      }

      //Converts dt attribute from Unix timestamp to readable date
      //Needed to add labels to 4 day forecast element
      function formatForecastDate(dt, index) {
        const date = new Date(dt * 1000); // Convert Unix timestamp to milliseconds

        if (index === 0) {
          return 'Tomorrow';
        }

        const options = { weekday: 'long', month: 'long', day: 'numeric' };
        return date.toLocaleDateString(undefined, options);
      }
    
      // Form submission listener
      document.getElementById('weatherForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const location = document.getElementById("locationInput").value;
        fetchWeather(location);
      });
    </script>
    
  </body>
</html>